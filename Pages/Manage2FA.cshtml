@page
@model WebApplication1.Pages.Manage2FAModel
@{
    ViewData["Title"] = "Manage Two-Factor Authentication";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="bi bi-shield-lock"></i> Manage Two-Factor Authentication</h3>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.StatusMessage))
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle"></i> @Model.StatusMessage
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    @if (TempData["WarningMessage"] != null)
                    {
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle"></i> @TempData["WarningMessage"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <div class="mb-4">
                        <h5>Current Status</h5>
                        @if (Model.Is2FAEnabled)
                        {
                            <div class="alert alert-success">
                                <i class="bi bi-shield-check"></i>
                                <strong>Two-Factor Authentication is ENABLED</strong>
                                <p class="mb-0 mt-2">Your account is protected with 2FA.</p>
                            </div>

                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-key"></i> Recovery Codes</h6>
                                    <p class="card-text">
                                        You have <strong>@Model.RemainingRecoveryCodes</strong> recovery code(s) remaining.
                                    </p>
                                    @if (Model.RemainingRecoveryCodes <= 3)
                                    {
                                        <div class="alert alert-warning mb-2">
                                            <i class="bi bi-exclamation-triangle"></i>
                                            You're running low on recovery codes. Consider generating new ones.
                                        </div>
                                    }
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <form method="post" asp-page-handler="GenerateRecoveryCodes" class="d-inline">
                                    <button type="submit" class="btn btn-warning w-100" 
                                            onclick="return confirm('This will invalidate your old recovery codes. Continue?');">
                                        <i class="bi bi-arrow-clockwise"></i> Generate New Recovery Codes
                                    </button>
                                </form>
                                
                                <form method="post" asp-page-handler="Disable2FA" class="d-inline">
                                    <button type="submit" class="btn btn-danger w-100" 
                                            onclick="return confirm('Are you sure you want to disable 2FA? This will make your account less secure.');">
                                        <i class="bi bi-shield-x"></i> Disable Two-Factor Authentication
                                    </button>
                                </form>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                <i class="bi bi-shield-exclamation"></i>
                                <strong>Two-Factor Authentication is DISABLED</strong>
                                <p class="mb-0 mt-2">Your account is not protected with 2FA. We strongly recommend enabling it.</p>
                            </div>

                            <div class="card mb-3 bg-light">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-info-circle"></i> Why Enable 2FA?</h6>
                                    <ul class="mb-0">
                                        <li>Adds an extra layer of security to your account</li>
                                        <li>Protects against password theft</li>
                                        <li>Works with popular authenticator apps</li>
                                        <li>Provides recovery codes for backup access</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="d-grid">
                                <a asp-page="/Enable2FA" class="btn btn-success btn-lg">
                                    <i class="bi bi-shield-plus"></i> Enable Two-Factor Authentication
                                </a>
                            </div>
                        }
                    </div>

                    @if (Model.NewRecoveryCodes != null && Model.NewRecoveryCodes.Any())
                    {
                        <hr />
                        
                        <div class="alert alert-danger">
                            <h5><i class="bi bi-exclamation-triangle-fill"></i> Your New Recovery Codes</h5>
                            <p>Store these recovery codes in a safe place. Your old recovery codes are no longer valid.</p>
                            <p class="mb-0"><strong>Each code can only be used once.</strong></p>
                        </div>

                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Recovery Codes:</h6>
                                <div class="row">
                                    @for (int i = 0; i < Model.NewRecoveryCodes.Count; i++)
                                    {
                                        <div class="col-md-6 mb-2">
                                            <code class="d-block p-2 bg-white border">@Model.NewRecoveryCodes[i]</code>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button onclick="window.print()" class="btn btn-outline-primary">
                                <i class="bi bi-printer"></i> Print Recovery Codes
                            </button>
                            <button onclick="downloadRecoveryCodes()" class="btn btn-outline-secondary">
                                <i class="bi bi-download"></i> Download Recovery Codes
                            </button>
                        </div>
                    }

                    <hr />

                    <div class="text-center">
                        <a asp-page="/Index" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Home
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @if (Model.NewRecoveryCodes != null && Model.NewRecoveryCodes.Any())
    {
        <script>
            function downloadRecoveryCodes() {
                const codes = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.NewRecoveryCodes));
                const text = "Two-Factor Authentication Recovery Codes\n" +
                           "==========================================\n\n" +
                           "IMPORTANT: Keep these codes safe and secure!\n" +
                           "Each code can only be used once.\n" +
                           "Your old recovery codes are NO LONGER VALID.\n\n" +
                           "Recovery Codes:\n" +
                           codes.join('\n') +
                           "\n\n" +
                           "Generated: " + new Date().toLocaleString();
                
                const blob = new Blob([text], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = '2FA-Recovery-Codes-NEW.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }
        </script>
    }
}

<style>
    @@media print {
        .btn, nav, footer {
            display: none !important;
        }
    }
</style>
