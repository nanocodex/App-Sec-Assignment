# Phone Number and Credit Card Formatting - Implementation & Security Analysis

## Overview

This document explains the complete implementation of phone number and credit card formatting, including the critical decision on **database storage format** and the security implications.

---

## Database Storage Decision: **Store WITHOUT Spaces**

### ? Final Decision: Store Raw Digits Only

**Phone Number**: `+6597593160` (NOT `+65 9759 3160`)  
**Credit Card**: `4111111111111111` (NOT `4111 1111 1111 1111`)

### Why Store Without Spaces?

#### 1. **Security - Injection Attack Prevention** ???

**Problem with Stored Spaces:**
```sql
-- If we store: "+65 9759 3160"
-- A malicious query might try:
WHERE Mobile = '+65 9759 3160' OR '1'='1'
```

**With Raw Digits:**
```sql
-- Stored: "+6597593160"
-- Cleaner validation:
WHERE Mobile = @MobileParam  -- Only digits and +
```

**Benefits:**
- ? Simpler validation (only digits and + allowed)
- ? No whitespace manipulation attacks
- ? Easier to detect injection patterns
- ? Consistent format for validation

#### 2. **XSS Prevention** ???

**Problem with Stored Spaces:**
```html
<!-- Spaces can hide malicious content -->
<script>alert('XSS')</script>
<!-- Could potentially be disguised as: -->
<   script   >alert('XSS')<   /script   >
```

**With Raw Digits:**
```
Only characters allowed: 0-9 and +
No possibility of HTML/script injection
```

#### 3. **Data Integrity** ?

**Consistent Storage:**
```
User Input 1: "4111 1111 1111 1111"  ? Store: "4111111111111111"
User Input 2: "4111111111111111"     ? Store: "4111111111111111"
User Input 3: "4111-1111-1111-1111"  ? Store: "4111111111111111"

All stored identically ? Easy comparison and validation
```

**Benefits:**
- ? No duplicates due to different spacing
- ? Easier database queries
- ? Consistent validation
- ? Simpler comparisons

#### 4. **Validation Simplicity** ?

**Server-Side Validation (SingaporeMobileAttribute.cs):**
```csharp
// Remove spaces before validation
mobile = Regex.Replace(mobile, @"\s", string.Empty);

// Now validate clean string
if (!Regex.IsMatch(mobile, @"^\+65[89]\d{7}$"))
{
    return new ValidationResult("Invalid format");
}
```

**Benefits:**
- ? Single validation pattern needed
- ? No complex spacing rules in database layer
- ? Easier to maintain
- ? Faster validation

#### 5. **Encryption Efficiency** ??

**Credit Card Encryption:**
```csharp
// Shorter string ? Faster encryption
"4111111111111111"  // 16 characters
vs
"4111 1111 1111 1111"  // 19 characters

// Result:
Encrypted: "CfDJ8Abc..." // 200+ characters (based on 16, not 19)
```

**Benefits:**
- ? Smaller encrypted blob
- ? Faster encryption/decryption
- ? Less database storage
- ? Better performance

#### 6. **Database Design Best Practice** ??

**Industry Standards:**
- PCI DSS: Store minimum required data
- GDPR: Data minimization principle
- OWASP: Normalize data before storage

**Example Schema:**
```sql
CREATE TABLE AspNetUsers (
    ...
    Mobile NVARCHAR(20),     -- "+6597593160" (14 chars) vs "+65 9759 3160" (17 chars)
    CreditCard NVARCHAR(MAX) -- Encrypted, but based on "4111111111111111" (16 chars)
)
```

---

## Implementation Details

### 1. Input Formatting (Client-Side)

**File:** `wwwroot/js/input-validation.js`

**Credit Card Formatting:**
```javascript
window.formatCreditCard = function (input) {
    // Remove existing spaces
    let value = input.value.replace(/\s/g, '');
    
    // Format in groups of 4
    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
    
    // Display: "4111 1111 1111 1111"
    input.value = formattedValue;
};
```

**Phone Number Formatting:**
```javascript
window.formatMobile = function (input) {
    let value = input.value.replace(/\s/g, '');
    
    if (value.startsWith('+65')) {
        // Singapore: +65 9759 3160
        const countryCode = value.substring(0, 3);
        const number = value.substring(3);
        if (number.length > 4) {
            formattedValue = countryCode + ' ' + number.substring(0, 4) + ' ' + number.substring(4);
        }
    }
    // ... other country codes
    
    input.value = formattedValue;
};
```

**User Experience:**
```
User types:    "4111111111111111"
Display shows: "4111 1111 1111 1111"
Stored in DB:  "4111111111111111" (encrypted)
```

### 2. Storage Processing (Server-Side)

**File:** `Pages/Register.cshtml.cs`

```csharp
// Sanitize inputs
var sanitizedMobile = _sanitizationService.SanitizeInput(RModel.Mobile);
var sanitizedCreditCard = _sanitizationService.SanitizeInput(RModel.CreditCard);

// Remove spaces before database storage (CRITICAL FOR SECURITY)
sanitizedMobile = sanitizedMobile.Replace(" ", "");
sanitizedCreditCard = sanitizedCreditCard.Replace(" ", "");

// Create user
var user = new ApplicationUser()
{
    Mobile = sanitizedMobile,                           // "+6597593160"
    CreditCard = _encryptionService.Encrypt(sanitizedCreditCard)  // Encrypted "4111111111111111"
};
```

**Flow:**
```
User Input:        "+65 9759 3160"
Sanitization:      "+65 9759 3160" (trim, remove null chars)
Remove Spaces:     "+6597593160"
Validation:        ? Passes (matches regex)
Database Storage:  "+6597593160"
```

### 3. Display Formatting (Client-Side)

**File:** `wwwroot/js/display-formatter.js`

```javascript
window.DisplayFormatter = {
    formatPhoneDisplay: function(phone) {
        const cleanPhone = phone.replace(/\s/g, '');
        
        if (cleanPhone.startsWith('+65')) {
            const countryCode = cleanPhone.substring(0, 3);
            const number = cleanPhone.substring(3);
            return `${countryCode} ${number.substring(0, 4)} ${number.substring(4)}`;
        }
        // No country code ? return as-is (no spacing)
        return cleanPhone;
    },

    formatCreditCardDisplay: function(cardNumber) {
        const cleanCard = cardNumber.replace(/\s/g, '');
        const formatted = cleanCard.match(/.{1,4}/g);
        return formatted ? formatted.join(' ') : cleanCard;
    }
};
```

**File:** `Pages/Index.cshtml`

```razor
<div class="col-md-8">
    <!-- Phone: "+6597593160" ? Display: "+65 9759 3160" -->
    <span id="phoneDisplay">@Model.CurrentUser.Mobile</span>
</div>

<div class="col-md-8">
    <!-- Card: "4111111111111111" ? Display: "4111 1111 1111 1111" -->
    <span id="cardDisplay">@Model.DecryptedCreditCard</span>
</div>

<script>
    // Format on page load
    var phoneElement = document.getElementById('phoneDisplay');
    var phone = phoneElement.textContent.trim();
    phoneElement.textContent = DisplayFormatter.formatPhoneDisplay(phone);

    var cardElement = document.getElementById('cardDisplay');
    var card = cardElement.textContent.trim();
    cardElement.textContent = DisplayFormatter.formatCreditCardDisplay(card);
</script>
```

**Flow:**
```
Database:    "+6597593160"
Decryption:  "+6597593160" (if encrypted)
Display:     "+65 9759 3160" (formatted via JavaScript)
```

---

## Security Analysis

### Attack Vector: SQL Injection

**Scenario:** Malicious user tries SQL injection via phone number

**With Spaces (Vulnerable):**
```
Input: "' OR '1'='1" (with spaces disguised)
Stored: "' OR '1'='1"
Query: WHERE Mobile = ''' OR ''1''=''1'' -- INJECTION SUCCESSFUL
```

**Without Spaces (Protected):**
```
Input: "' OR '1'='1"
Validation: FAILS (only digits and + allowed)
Stored: Nothing (rejected before storage)
Query: Never executed
```

**Our Protection:**
```csharp
// Server-side validation (SingaporeMobileAttribute.cs)
mobile = Regex.Replace(mobile, @"\s", string.Empty);
if (!Regex.IsMatch(mobile, @"^\+65[89]\d{7}$"))
{
    return new ValidationResult("Invalid format"); // Rejects injection
}

// Entity Framework (parameterized queries)
var user = _context.Users.Where(u => u.Mobile == mobile).FirstOrDefault();
// SQL: SELECT * FROM Users WHERE Mobile = @mobile
```

### Attack Vector: XSS

**Scenario:** Malicious user tries XSS via credit card

**With Spaces (Potentially Vulnerable):**
```html
Input: "<script>alert('XSS')</script>"
Stored: "< script >alert('XSS')< /script >" (with spaces)
Display: Potentially executed if not encoded
```

**Without Spaces (Protected):**
```
Input: "<script>alert('XSS')</script>"
Validation: FAILS (only digits allowed)
Stored: Nothing (rejected before storage)
Display: Never rendered
```

**Our Protection:**
```csharp
// Validation (Credit Card must pass Luhn algorithm)
sanitizedCreditCard = sanitizedCreditCard.Replace(" ", "");
if (!/^\d{13,19}$/.test(sanitizedCreditCard)) {
    return { valid: false }; // Rejects non-digits
}

// Razor automatic encoding
@Model.DecryptedCreditCard  // Automatically HTML-encoded
```

### Attack Vector: Data Manipulation

**Scenario:** Different spacing creates duplicate entries

**With Spaces (Problem):**
```
User 1 registers: Mobile = "+65 9759 3160"
User 2 registers: Mobile = "+659759 3160"
User 3 registers: Mobile = "+6597593160"

Database has 3 different entries for same number!
```

**Without Spaces (Solution):**
```
User 1 registers: Mobile = "+6597593160" ? Stored: "+6597593160"
User 2 registers: Mobile = "+659759 3160" ? Normalized: "+6597593160" ? DUPLICATE DETECTED
User 3 registers: Mobile = "+65 9759 3160" ? Normalized: "+6597593160" ? DUPLICATE DETECTED

Database has 1 entry (correct)
```

---

## Complete Data Flow

### Registration Flow

```
???????????????????????????????????????????????????????????????
? 1. USER INPUT (Register Form)                              ?
?    Phone:  "+65 9759 3160"                                  ?
?    Card:   "4111 1111 1111 1111"                            ?
???????????????????????????????????????????????????????????????
                  ?
???????????????????????????????????????????????????????????????
? 2. CLIENT-SIDE FORMATTING (input-validation.js)            ?
?    formatMobile()      ? Display: "+65 9759 3160"           ?
?    formatCreditCard()  ? Display: "4111 1111 1111 1111"     ?
?    (User sees formatted input as they type)                 ?
???????????????????????????????????????????????????????????????
                  ?
???????????????????????????????????????????????????????????????
? 3. CLIENT-SIDE VALIDATION (input-validation.js)            ?
?    validateMobile()      ? ? Valid                         ?
?    validateCreditCard()  ? ? Valid (Luhn check)            ?
???????????????????????????????????????????????????????????????
                  ?
???????????????????????????????????????????????????????????????
? 4. FORM SUBMISSION                                          ?
?    POST to /Register with:                                  ?
?    Mobile:      "+65 9759 3160"                             ?
?    CreditCard:  "4111 1111 1111 1111"                       ?
???????????????????????????????????????????????????????????????
                  ?
???????????????????????????????????????????????????????????????
? 5. SERVER-SIDE SANITIZATION (Register.cshtml.cs)           ?
?    SanitizeInput()  ? Remove null chars, trim              ?
?    Result:                                                  ?
?      Mobile:     "+65 9759 3160"                            ?
?      CreditCard: "4111 1111 1111 1111"                      ?
???????????????????????????????????????????????????????????????
                  ?
???????????????????????????????????????????????????????????????
? 6. REMOVE SPACES (Register.cshtml.cs) ? CRITICAL           ?
?    mobile.Replace(" ", "")                                  ?
?    creditCard.Replace(" ", "")                              ?
?    Result:                                                  ?
?      Mobile:     "+6597593160"                              ?
?      CreditCard: "4111111111111111"                         ?
???????????????????????????????????????????????????????????????
                  ?
???????????????????????????????????????????????????????????????
? 7. SERVER-SIDE VALIDATION (Attributes)                     ?
?    SingaporeMobileAttribute  ? ? "+6597593160"            ?
?    [CreditCard] Attribute    ? ? "4111111111111111"       ?
???????????????????????????????????????????????????????????????
                  ?
???????????????????????????????????????????????????????????????
? 8. ENCRYPTION (for Credit Card only)                       ?
?    Encrypt("4111111111111111")                              ?
?    ? "CfDJ8Nq5ZBXqL9wK8F3mPqJZ0A1b2C3d..."                  ?
???????????????????????????????????????????????????????????????
                  ?
???????????????????????????????????????????????????????????????
? 9. DATABASE STORAGE (AspNetUsers table)                    ?
?    Mobile:     "+6597593160" (plain text)                   ?
?    CreditCard: "CfDJ8Nq5..." (encrypted)                    ?
???????????????????????????????????????????????????????????????
```

### Display Flow (Homepage)

```
???????????????????????????????????????????????????????????????
? 1. DATABASE RETRIEVAL                                       ?
?    Mobile:     "+6597593160"                                ?
?    CreditCard: "CfDJ8Nq5..." (encrypted)                    ?
???????????????????????????????????????????????????????????????
                  ?
???????????????????????????????????????????????????????????????
? 2. DECRYPTION (Index.cshtml.cs)                             ?
?    Decrypt("CfDJ8Nq5...")                                   ?
?    ? "4111111111111111"                                     ?
???????????????????????????????????????????????????????????????
                  ?
???????????????????????????????????????????????????????????????
? 3. RENDER TO PAGE (Index.cshtml)                            ?
?    <span id="phoneDisplay">+6597593160</span>               ?
?    <span id="cardDisplay">4111111111111111</span>           ?
???????????????????????????????????????????????????????????????
                  ?
???????????????????????????????????????????????????????????????
? 4. CLIENT-SIDE FORMATTING (display-formatter.js)            ?
?    formatPhoneDisplay()      ? "+65 9759 3160"              ?
?    formatCreditCardDisplay() ? "4111 1111 1111 1111"        ?
???????????????????????????????????????????????????????????????
                  ?
???????????????????????????????????????????????????????????????
? 5. USER SEES                                                ?
?    Mobile:      "+65 9759 3160"                             ?
?    Credit Card: "4111 1111 1111 1111"                       ?
???????????????????????????????????????????????????????????????
```

---

## Formatting Rules

### Phone Number Formatting

| Country Code | Input | Stored | Display |
|--------------|-------|--------|---------|
| None (SG local) | `97593160` | `97593160` | `97593160` (no spacing) |
| Singapore (+65) | `+6597593160` | `+6597593160` | `+65 9759 3160` |
| Malaysia (+60) | `+60123456789` | `+60123456789` | `+60 12 345 6789` |
| Indonesia (+62) | `+6281234567890` | `+6281234567890` | `+62 812 3456 7890` |

### Credit Card Formatting

| Type | Input | Stored | Display |
|------|-------|--------|---------|
| Visa (16 digits) | `4111111111111111` | `4111111111111111` (encrypted) | `4111 1111 1111 1111` |
| Amex (15 digits) | `378282246310005` | `378282246310005` (encrypted) | `3782 8224 6310 005` |
| Any valid card | `4532015112830366` | `4532015112830366` (encrypted) | `4532 0151 1283 0366` |

---

## Testing

### Test Input Formatting

**Phone Number:**
```
1. Go to /Register
2. Type: "6597593160"
3. Observe: "+65" appears, then "+65 9759 3160"
4. Submit form
5. Check database: "+6597593160" (no spaces)
6. View homepage: "+65 9759 3160" (with spaces)
? Pass
```

**Credit Card:**
```
1. Go to /Register
2. Type: "4111111111111111"
3. Observe: "4111 1111 1111 1111" (auto-formatted)
4. Submit form
5. Check database: Encrypted blob (based on "4111111111111111")
6. View homepage: "4111 1111 1111 1111"
? Pass
```

### Test Security

**SQL Injection:**
```sql
Input:  "' OR '1'='1"
Result: Validation fails (only digits and + allowed)
Status: ? Protected
```

**XSS:**
```html
Input:  "<script>alert('XSS')</script>"
Result: Validation fails (only digits allowed for credit card)
Status: ? Protected
```

---

## Files Modified/Created

### Created:
- ? `wwwroot/js/display-formatter.js` - Display formatting utilities

### Modified:
- ? `Pages/Register.cshtml.cs` - Added space removal before storage
- ? `Pages/Index.cshtml` - Added display formatting
- ? `wwwroot/js/input-validation.js` - Already has formatting functions

---

## Summary

### ? Database Storage: **NO SPACES**

**Reasons:**
1. ??? **Security**: Prevents injection attacks
2. ? **Integrity**: Consistent data format
3. ? **Performance**: Faster encryption/validation
4. ?? **Best Practice**: Industry standard

### ? Display Formatting: **WITH SPACES**

**Benefits:**
1. ??? **Readability**: Easier to read
2. ? **UX**: Professional appearance
3. ?? **Standards**: Matches expectations

### ? Input Formatting: **WITH SPACES (Real-time)**

**Benefits:**
1. ?? **UX**: Instant visual feedback
2. ? **Validation**: Real-time error checking
3. ?? **Convenience**: Auto-formatting as user types

**Final Verdict:** Store clean, display formatted! ??

